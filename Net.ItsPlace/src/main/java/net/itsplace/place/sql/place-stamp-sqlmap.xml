<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="stamp">
	<typeAlias type="net.itsplace.domain.Stamp" alias="Stamp"/>	    
   
	 <insert id="saveStamp" parameterClass="Stamp">
         INSERT INTO PSTAMP(STAMPID, EMAIL, STATUS, REMARK, MOBILE)
         VALUES (#placeStamp.stampid#, #user.email#,  'P', #remark#, #mobile#)
    </insert>
    <update id="burnStamp" parameterClass="Stamp">
         UPDATE PSTAMP
         SET STATUS = 'U',
         	 USEDATE =  CURRENT_TIMESTAMP()
         WHERE STATUS = 'P'
         AND PID = #pid#
         
    </update>
    
    <update id="cancelStamp" parameterClass="String">
         UPDATE PSTAMP SET STATUS ='C'
         WHERE PID = #pid#         
    </update>
    
    <!-- 가맹점 스탬프 사용자 (가맹점 비회원) 검색 -->
    <select id="getPlaceStampUserList"  parameterClass="java.util.Map" resultClass="Stamp"> 
      SELECT  sql_calc_found_rows  B.stampedTotal, B.stampedLastDate, A.PROFILEIMAGEURL, A.EMAIL, A.NAME, A.MOBILE 
	  FROM PUSER A
      LEFT OUTER JOIN 
						  (
						  		 	SELECT  B.EMAIL, COUNT(B.PID) AS stampedTotal, MAX(B.SAVEDATE) AS stampedLastDate
									FROM  PLACESTAMP  A
										INNER JOIN PSTAMP B
										ON A.STAMPID = B.STAMPID
					<![CDATA[		WHERE B.STATUS <> 'C'        ]]> 
									AND A.FID= #fid#
									GROUP BY B.EMAIL
					     ) B
		ON A.EMAIL = B.EMAIL	
		WHERE  A.ISDELETE ='N' 
				AND A.ROLE ='ROLE_USER'
		<isNotEmpty property="search">
	    	 	OR A.NAME like CONCAT('%',#search#,'%')
	    	 	OR A.EMAIL like CONCAT('%',#search#,'%')
	    	 	OR A.MOBILE like CONCAT('%',#search#,'%')
	    </isNotEmpty>
	 ORDER BY $sortColumn$ $sortDirection$
     LIMIT #startRow#,#endRow#
    </select>
</sqlMap>