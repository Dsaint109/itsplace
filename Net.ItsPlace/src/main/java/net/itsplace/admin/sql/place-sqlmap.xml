<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap
	PUBLIC "-//ibatis.apache.org//DTD SQL Map 2.0//EN"
	"http://ibatis.apache.org/dtd/sql-map-2.dtd">
<sqlMap namespace="admin">
	
	<typeAlias type="net.itsplace.domain.Place" alias="Place"/>
	<typeAlias type="net.itsplace.domain.Category" alias="Category"/>
	<typeAlias type="net.itsplace.domain.PlaceStamp" alias="PlaceStamp"/>
	<typeAlias type="net.itsplace.domain.Pmedia" alias="Pmedia"/>
<!-- 
	
	<resultMap id="PlaceJoinAddress" class="Place" >
		<result property="fid" column="FID"></result>
		<result property="fname" column="FNAME"></result>
		<result property="latitude" column="LATITUDE"></result>
		<result property="longitude" column="LONGITUDE"></result>
		<result property="nldno" column="NLDNO"></result>
		<result property="phone1" column="PHONE1"></result>
		<result property="mobile" column="MOBILE"></result>
		<result property="imageHost" column="IMAGEHOST"></result>
		<result property="fileName" column="FILENAME"></result>
		<result property="isAuth" column="ISAUTH"></result>
		<result property="remark" column="REMARK"></result>
		<result property="stype" column="STYPE"></result>
		<result property="email" column="EMAIL"></result>
		<result property="park" column="PARK"></result>
		<result property="closedday" column="CLOSEDDAY"></result>
		<result property="openday" column="OPENDAY"></result>
		<result property="website" column="WEBSITE"></result>
		<result property="info" column="INFO"></result>
		<result property="qrcode" column="QRCODE"></result>
		<result property="saveDate" column="SAVEDATE"></result>
		<result property="editDate" column="EDITDATE"></result>
		
		
		
								
	</resultMap>
	 -->
	<select id="getPlaceList" resultClass="Place" parameterClass="java.util.Map">
    	 SELECT  sql_calc_found_rows  
    	 		A.ISAUTH, A.FID, A.FNAME, A.LATITUDE, A.LONGITUDE, A.NLDNO, A.MOBILE, A.PHONE1,
    	 		I.BASNAME AS IMAGEHOST, A.FILENAME, A.CATEGORY,  A.SERVICETYPE, A.REMARK,
    	 		A.EMAIL, A.CLOSEDDAY, A.OPENDAY, A.WEBSITE, A.INFO, A.QRCODE, A.SAVEDATE, A.EDITDATE,
    	 		S.BASNAME AS SERVICETYPE,
    	 		P.BASNAME AS PLACETYPE,
		   	 	A.FULLADDRESS,
		   	 	A.SIDO,
		   	 	A.GUGUN,
		   	 	A.DONG,
		   	 	A.NEWADDRESS,
		   	 	A.PAYINFO,
		   	 	A.PARKINFO,
		   	 	A.BLDINFO
		 FROM 
		 	PLACE A
		 LEFT OUTER JOIN
		 	PBASCD S
         		ON A.SERVICETYPE = S.BASECD	
         		AND S.GRPCD = 'SERVICETYPE'
		 LEFT OUTER JOIN
		 	PBASCD P
         		ON A.PLACETYPE = P.BASECD	
         		AND P.GRPCD = 'PLACETYPE'
          LEFT OUTER JOIN
		 	PBASCD I
         		ON A.IMAGEHOST = I.BASECD	
         		AND I.GRPCD = 'MEDIA'		
         		AND I.BASEKEY = 'IMAGEHOST'
		
         <dynamic>
	    	 <isNotEmpty property="search">
	    	 	WHERE A.FNAME like CONCAT('%',#search#,'%')
	    	 	OR A.FULLADDRESS like CONCAT('%',#search#,'%')
	    	 	OR MOBILE like CONCAT('%',#search#,'%')
	    	 </isNotEmpty>
    	 </dynamic>
    	 ORDER BY $sortColumn$ $sortDirection$
    	 LIMIT #startRow# , #endRow#	
    </select>
    <select id="getPlace" resultClass="Place">
        SELECT A.FID, 
        	   A.FNAME, 
        	   A.NAME,
        	   A.MOBILE,
         	   A.PHONE1, 
         	   A.LATITUDE, 
         	   A.LONGITUDE, 
         	   A.NLDNO, 
         	   I.BASNAME AS IMAGEHOST, 
         	   A.FILENAME, 
         	   A.ISAUTH, 
         	   A.REMARK, 
         	   A.CATEGORY, 
         	   A.SERVICETYPE,
         	   A.PLACETYPE,
         	   A.FULLADDRESS,
		   	   A.SIDO,
		   	   A.GUGUN,
		   	   A.DONG,
		   	   A.NEWADDRESS,
		   	   A.PAYINFO,
		   	   A.PARKINFO,
		   	   A.BLDINFO
        FROM PLACE A
          LEFT OUTER JOIN
		 	PBASCD I
         		ON A.IMAGEHOST = I.BASECD	
         		AND I.GRPCD = 'MEDIA'		
         		AND I.BASEKEY = 'IMAGEHOST'
        WHERE A.FID = #fid#
      
    </select>
    <insert id="savePlace" parameterClass="Place">
         
        INSERT INTO PLACE(FNAME, NAME, MOBILE, FILENAME, PLACETYPE,  ISAUTH, STARTDATE, SAVEDATE, ENDDATE)
        VALUES (#fname#, #name#, #mobile#,  #fileName#, #placeType#, 'N', now(),now(),now())
         
        <selectKey keyProperty="fid" resultClass="java.lang.Integer">
	    	 SELECT last_insert_id()
	    </selectKey>
	    
    </insert>
    <update id="editPlace" parameterClass="Place">
         UPDATE  PLACE
         SET 
         	 NAME = #name# ,
         	 FNAME = #fname# ,
             MOBILE = #mobile#,
             PHONE1 = #phone1#, 
             NLDNO = #nldno#, 
             ISAUTH = #isAuth#,
             REMARK = #remark#,
             CATEGORY = #category#,
             SERVICETYPE = #serviceType#,
             PLACETYPE = #placeType#,
             LATITUDE = #latitude#, 
         	 LONGITUDE = #longitude#, 
             FULLADDRESS = #fullAddress#,
		   	 SIDO = #sido#,
		   	 GUGUN = #gugun#,
		   	 DONG = #dong#,
		   	 NEWADDRESS = #newAddress#
      	WHERE FID = #fid#        
    </update>
    <update id="enablePlace" parameterClass="int">
         UPDATE  PLACE
         SET ISAUTH = 'Y'             
      	WHERE FID = #fid#        
    </update>
    <update id="disablePlace" parameterClass="int">
         UPDATE  PLACE
         SET ISAUTH = 'N'             
      	WHERE FID = #fid#        
    </update>
    <update id="editPlacerQrcode" parameterClass="Place">
         UPDATE PLACE 
         SET QRCODE = #qrcode#            
         WHERE FID=#fid#
    </update>  
    <update id="editMcode" parameterClass="Place">
         UPDATE PLACE 
         SET
         	 MCODE = #mcode#,
         	 AUTHCODE = #authCode#,
             QRAUTHCODE = #qrAuthCode#
         WHERE FID=#fid#
    </update>
    <update id="editAuthCode" parameterClass="Place">
         UPDATE PLACE 
         SET
         	 AUTHCODE = #authCode#            
         WHERE FID=#fid#
    </update>  
	<select id="getMcode" parameterClass="int" resultClass="String">
		SELECT MCODE FROM PLACE WHERE FID = #fid# 
	</select>   
  
</sqlMap>